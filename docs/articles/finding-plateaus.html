<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finding Plateaus • curvish</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Finding Plateaus">
<meta property="og:description" content="curvish">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">curvish</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/finding-plateaus.html">Finding Plateaus</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Finding Plateaus</h1>
            
      
      
      <div class="hidden name"><code>finding-plateaus.Rmd</code></div>

    </div>

    
    
<p>Along with this package, this vignette uses the <code>gratia</code> and <code>mgcv</code> packages for comparsons. I’ll start with the first example from <code>mgcv</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># library(curvish)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: nlme</span>
<span class="co">#&gt; This is mgcv 1.8-31. For overview type 'help("mgcv-package")'.</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gavinsimpson.github.io/gratia">gratia</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>


<span class="co">#Below from ?gam</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="co">## simulate some data... </span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gamSim.html">gamSim</a></span><span class="op">(</span><span class="fl">1</span>,n<span class="op">=</span><span class="fl">200</span>,dist<span class="op">=</span><span class="st">"normal"</span>,scale<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span>,data<span class="op">=</span><span class="va">d</span>, method <span class="op">=</span> <span class="st">'REML'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">fit</span>,pages<span class="op">=</span><span class="fl">1</span>,residuals<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>  <span class="co">## show partial residuals</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/setup-1.png" width="480"></p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">fit</span>,pages<span class="op">=</span><span class="fl">1</span>,seWithMean<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">## `with intercept' CIs</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/setup-2.png" width="480"></p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co">## run some basic model checks, including checking</span>
<span class="co">## smoothing basis dimensions...</span>
<span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.check.html">gam.check</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/setup-3.png" width="480"></p>
<pre><code>#&gt; Gu &amp; Wahba 4 term additive model
#&gt; 
#&gt; Family: gaussian 
#&gt; Link function: identity 
#&gt; 
#&gt; Formula:
#&gt; y ~ s(x0) + s(x1) + s(x2) + s(x3)
#&gt; 
#&gt; Parametric coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)   7.2696     0.1456   49.94   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Approximate significance of smooth terms:
#&gt;         edf Ref.df      F  p-value    
#&gt; s(x0) 3.058  3.788  5.881 0.000277 ***
#&gt; s(x1) 2.597  3.224 44.684  &lt; 2e-16 ***
#&gt; s(x2) 7.782  8.614 32.919  &lt; 2e-16 ***
#&gt; s(x3) 1.001  1.001  0.538 0.464311    
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; R-sq.(adj) =  0.687   Deviance explained = 70.9%
#&gt; -REML = 446.46  Scale est. = 4.2373    n = 200
#&gt; 
#&gt; Method: REML   Optimizer: outer newton
#&gt; full convergence after 6 iterations.
#&gt; Gradient range [-0.000243307,0.0001095225]
#&gt; (score 446.4563 &amp; scale 4.237334).
#&gt; Hessian positive definite, eigenvalue range [0.000243146,97.63853].
#&gt; Model rank =  37 / 37 
#&gt; 
#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
#&gt; indicate that k is too low, especially if edf is close to k'.
#&gt; 
#&gt;         k'  edf k-index p-value  
#&gt; s(x0) 9.00 3.06    1.11    0.89  
#&gt; s(x1) 9.00 2.60    1.01    0.52  
#&gt; s(x2) 9.00 7.78    1.10    0.92  
#&gt; s(x3) 9.00 1.00    0.91    0.07 .
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<div id="derivatives" class="section level1">
<h1 class="hasAnchor">
<a href="#derivatives" class="anchor"></a>Derivatives</h1>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">eps</span> <span class="op">=</span> <span class="fl">1e-07</span>
<span class="va">res</span> <span class="op">=</span> <span class="fl">200</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span>,data<span class="op">=</span><span class="va">d</span>, method <span class="op">=</span> <span class="st">'REML'</span><span class="op">)</span>
<span class="va">deriv_su</span> <span class="op">&lt;-</span> <span class="fu">gratia</span><span class="fu">::</span><span class="fu"><a href="https://gavinsimpson.github.io/gratia//reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, level <span class="op">=</span> <span class="fl">.95</span>, 
                                interval <span class="op">=</span> <span class="st">'simultaneous'</span>, unconditional <span class="op">=</span> <span class="cn">TRUE</span>, n_sim <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>
<span class="va">deriv_sc</span> <span class="op">&lt;-</span> <span class="fu">gratia</span><span class="fu">::</span><span class="fu"><a href="https://gavinsimpson.github.io/gratia//reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, level <span class="op">=</span> <span class="fl">.95</span>, 
                                interval <span class="op">=</span> <span class="st">'simultaneous'</span>, unconditional <span class="op">=</span> <span class="cn">FALSE</span>, n_sim <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>
<span class="va">deriv_cu</span> <span class="op">&lt;-</span> <span class="fu">gratia</span><span class="fu">::</span><span class="fu"><a href="https://gavinsimpson.github.io/gratia//reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, level <span class="op">=</span> <span class="fl">.95</span>, 
                                interval <span class="op">=</span> <span class="st">'confidence'</span>, unconditional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">deriv_cc</span> <span class="op">&lt;-</span> <span class="fu">gratia</span><span class="fu">::</span><span class="fu"><a href="https://gavinsimpson.github.io/gratia//reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, level <span class="op">=</span> <span class="fl">.95</span>, 
                                interval <span class="op">=</span> <span class="st">'confidence'</span>, unconditional <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<div id="sources-of-uncertainty" class="section level2">
<h2 class="hasAnchor">
<a href="#sources-of-uncertainty" class="anchor"></a>Sources of uncertainty</h2>
<p>I’ll start off by considering the important issue of simultaneous confidence intervals described in this <a href="https://fromthebottomoftheheap.net/2014/06/16/simultaneous-confidence-intervals-for-derivatives/">blog post</a> by the author of the <code>gratia</code> package. Essentially, if we are to compare, point by point, the confidence interval, we need to correct for multiple comparisons. See below for how this changes the width of the interval around the first derivative plot. Also note how making the interval unconditional on the smooth terms slightly widens it. This is to add in the uncertainty about the exact shape of the smooth.</p>
<p>The Bayesian method does not face this particular multiple comparison problem. I use the posterior of the derivative to compute the posterior for the difference between the derivative at a given age to the derivative at the age where the median posterior derivative is at its maximum (i.e., at [INSERT HERE] years). I then compute the 95% credible interval for that statistic at each age. If at each age 95% of the posterior falls in a certain range, then we can also be sure that 95% of the posterior across all ages falls in this range, so we are not inflating the probability that we make a mistake in deciding that this range includes the true region of steepest slope.</p>
<p>In the plots below, you will notice that the more sources of uncertainty we account for in the ML models (that is, the non-Bayesian models), the wider the confidence regions are. The widest interval is when we account for the multiple tests (i.e., a test at each age we’re interested in examining the derivative), and when we account for uncertainty in the exact shape of the spline. “Simul” refers to the use of simultaneous confidence intervals that account for multiple testing, whereas “Conf” refers to traditional confidence intervals. “Uncon” refers to intervals that are unconditional on the choice of shape of the spline and “Cond” refers to intervals that are conditional on the exact trajectory as estimated.</p>
<p>The derivative of the Bayesian model falls somewhere in the middle, and has a slightly different shape.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">deriv_su</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span>, y <span class="op">=</span> <span class="va">derivative</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Simul/Uncond'</span>, fill <span class="op">=</span> <span class="st">'Simul/Uncond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_sc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Simul/Cond'</span>, fill <span class="op">=</span> <span class="st">'Simul/Cond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_cu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Conf/Uncond'</span>, fill <span class="op">=</span> <span class="st">'Conf/Uncond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_cc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Conf/Cond'</span>, fill <span class="op">=</span> <span class="st">'Conf/Cond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Simul/Uncond'</span>, <span class="st">'Simul/Cond'</span>, <span class="st">'Conf/Uncond'</span>, <span class="st">'Conf/Cond'</span>, <span class="st">'Bayes'</span><span class="op">)</span>,
                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cpal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>, <span class="st">'#000000'</span><span class="op">)</span>,
                     name <span class="op">=</span> <span class="st">'Type of interval'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Simul/Uncond'</span>, <span class="st">'Simul/Cond'</span>, <span class="st">'Conf/Uncond'</span>, <span class="st">'Conf/Cond'</span>, <span class="st">'Bayes'</span><span class="op">)</span>,
                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cpal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>, <span class="st">'#000000'</span><span class="op">)</span>,
                     name <span class="op">=</span> <span class="st">'Type of interval'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'x2'</span>, y <span class="op">=</span> <span class="st">'y'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
</div>
<div id="bayesian-gam-and-derivative" class="section level1">
<h1 class="hasAnchor">
<a href="#bayesian-gam-and-derivative" class="anchor"></a>Bayesian GAM and derivative</h1>
<p>Using brms.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: Rcpp</span>
<span class="co">#&gt; Loading 'brms' package (version 2.14.0). Useful instructions</span>
<span class="co">#&gt; can be found by typing help('brms'). A more detailed introduction</span>
<span class="co">#&gt; to the package is available through vignette('brms_overview').</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'brms'</span>
<span class="co">#&gt; The following object is masked from 'package:gratia':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     posterior_samples</span>
<span class="co">#&gt; The following objects are masked from 'package:mgcv':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     s, t2</span>
<span class="co">#&gt; The following object is masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     ar</span>
<span class="va">fit_b</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span><span class="op">)</span>, 
                   data<span class="op">=</span><span class="va">d</span>,
                   chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>,
                   iter <span class="op">=</span> <span class="fl">4500</span>, warmup <span class="op">=</span> <span class="fl">2000</span>,
                   control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.999</span>, max_treedepth <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                   file <span class="op">=</span> <span class="st">'fit_b'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_b</span><span class="op">)</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: y ~ s(x0) + s(x1) + s(x2) + s(x3) </span>
<span class="co">#&gt;    Data: d (Number of observations: 200) </span>
<span class="co">#&gt; Samples: 4 chains, each with iter = 4500; warmup = 2000; thin = 1;</span>
<span class="co">#&gt;          total post-warmup samples = 10000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Smooth Terms: </span>
<span class="co">#&gt;            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sds(sx0_1)     3.12      1.53     1.14     7.10 1.00     6636     6285</span>
<span class="co">#&gt; sds(sx1_1)     2.31      1.34     0.63     5.74 1.00     5398     5003</span>
<span class="co">#&gt; sds(sx2_1)    19.60      5.73    11.17    33.27 1.00     3839     5141</span>
<span class="co">#&gt; sds(sx3_1)     2.86      2.90     0.07    10.55 1.00     2147     4321</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept     7.27      0.15     6.97     7.56 1.00    18645     6951</span>
<span class="co">#&gt; sx0_1         0.18      5.65   -10.96    11.94 1.00     7798     5872</span>
<span class="co">#&gt; sx1_1         9.61      4.41     0.86    18.91 1.00     7884     6813</span>
<span class="co">#&gt; sx2_1        39.91     13.17    13.63    65.22 1.00     9478     7320</span>
<span class="co">#&gt; sx3_1        -2.41      6.73   -20.75     8.28 1.00     4842     3150</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     2.07      0.11     1.86     2.31 1.00    11352     6515</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">fit_b</span>, ask <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-4-1.png" width="700"><img src="finding-plateaus_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/conditional_smooths.brmsfit.html">conditional_smooths</a></span><span class="op">(</span><span class="va">fit_b</span>, smooths <span class="op">=</span> <span class="st">'s(x2)'</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-4-3.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit">

<span class="va">deriv_b</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit_b</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">deriv_su</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span>, y <span class="op">=</span> <span class="va">derivative</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Simul/Uncond'</span>, fill <span class="op">=</span> <span class="st">'Simul/Uncond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_sc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Simul/Cond'</span>, fill <span class="op">=</span> <span class="st">'Simul/Cond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_cu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Conf/Uncond'</span>, fill <span class="op">=</span> <span class="st">'Conf/Uncond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_cc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, color <span class="op">=</span> <span class="st">'Conf/Cond'</span>, fill <span class="op">=</span> <span class="st">'Conf/Cond'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_b</span><span class="op">$</span><span class="va">deriv_posterior_summary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">mean</span>, ymin <span class="op">=</span> <span class="va">l</span>, ymax <span class="op">=</span> <span class="va">u</span>, color <span class="op">=</span> <span class="st">'Bayes'</span>, fill <span class="op">=</span> <span class="st">'Bayes'</span><span class="op">)</span>, 
              alpha <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">deriv_b</span><span class="op">$</span><span class="va">deriv_posterior_summary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Simul/Uncond'</span>, <span class="st">'Simul/Cond'</span>, <span class="st">'Conf/Uncond'</span>, <span class="st">'Conf/Cond'</span>, <span class="st">'Bayes'</span><span class="op">)</span>,
                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#aaaaaa'</span>, <span class="va">cpal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                     name <span class="op">=</span> <span class="st">'Type of interval'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Simul/Uncond'</span>, <span class="st">'Simul/Cond'</span>, <span class="st">'Conf/Uncond'</span>, <span class="st">'Conf/Cond'</span>, <span class="st">'Bayes'</span><span class="op">)</span>,
                    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#222222'</span>, <span class="va">cpal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                    name <span class="op">=</span> <span class="st">'Type of interval'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'x2'</span>, y <span class="op">=</span> <span class="st">'y'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Ignoring unknown aesthetics: y</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-4-4.png" width="700"></p>
<div id="plot-method" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-method" class="anchor"></a>Plot method</h2>
<p>The package can plot the derivative and the smooth.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, deriv <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b</span>, robust <span class="op">=</span> <span class="cn">TRUE</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
</div>
</div>
<div id="finding-regions-of-difference" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-regions-of-difference" class="anchor"></a>Finding regions of difference</h1>
<p>There are ways to do this using the <code>gratia</code> package and fequentist inference. An example is <a href="http://johnflournoy.science/hcpd_myelin_gam_boot/test_gam_deriv_sandbox.html">here</a>. This vignette will focus on the Bayesian approach implemented in <code>curvish</code>.</p>
<div id="x-value-for-slope-property" class="section level2">
<h2 class="hasAnchor">
<a href="#x-value-for-slope-property" class="anchor"></a>X value for slope property</h2>
<p>For example, you might want to find the most probably X value for where the slope is steepest (positive or negative), or closest to 0.</p>
<div id="max" class="section level3">
<h3 class="hasAnchor">
<a href="#max" class="anchor"></a>Max</h3>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="va">max_p</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_maxy</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit_b</span>, term <span class="op">=</span> <span class="st">'x2'</span>, 
                                      n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, 
                                      multimodal <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fl">.95</span>, 
                                      summary_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">max_p</span><span class="op">$</span><span class="va">param_posterior_sum</span>
<span class="co">#&gt;             begin         end</span>
<span class="co">#&gt; [1,] -0.004961324 0.004985914</span>
<span class="co">#&gt; [2,]  0.030848733 0.044774866</span>
<span class="co">#&gt; [3,]  0.060690447 0.148226143</span>
<span class="co">#&gt; attr(,"credMass")</span>
<span class="co">#&gt; [1] 0.95</span>
<span class="co">#&gt; attr(,"height")</span>
<span class="co">#&gt; [1] 1.667861</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_p</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>design <span class="op">=</span> <span class="st">"
A
B"</span>, guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div id="two-other-views" class="section level4">
<h4 class="hasAnchor">
<a href="#two-other-views" class="anchor"></a>Two other views</h4>
<p>You can set a constrained range, and wether to use the mode or the median within each chunk of the HPDI.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_p</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_p</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.15</span><span class="op">)</span>, mode <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">'collect'</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
</div>
<div id="min" class="section level3">
<h3 class="hasAnchor">
<a href="#min" class="anchor"></a>Min</h3>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">min_p</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_miny</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit_b</span>, term <span class="op">=</span> <span class="st">'x2'</span>, 
                                       n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, 
                                       multimodal <span class="op">=</span> <span class="cn">FALSE</span>, prob <span class="op">=</span> <span class="fl">.95</span>, 
                                       summary_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">min_p</span><span class="op">$</span><span class="va">param_posterior_sum</span>
<span class="co">#&gt;              x2</span>
<span class="co">#&gt; lower 0.3114112</span>
<span class="co">#&gt; upper 0.3615319</span>
<span class="co">#&gt; attr(,"credMass")</span>
<span class="co">#&gt; [1] 0.95</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">min_p</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>design <span class="op">=</span> <span class="st">"
A
B"</span>, guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div id="other-view" class="section level4">
<h4 class="hasAnchor">
<a href="#other-view" class="anchor"></a>Other view</h4>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">min_p</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.4</span><span class="op">)</span>, adjust <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">min_p</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.4</span><span class="op">)</span>, adjust <span class="op">=</span> <span class="fl">1.75</span>, robust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
</div>
</div>
<div id="near-0" class="section level3">
<h3 class="hasAnchor">
<a href="#near-0" class="anchor"></a>Near 0</h3>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">zero_p</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_yequalto</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit_b</span>, term <span class="op">=</span> <span class="st">'x2'</span>, 
                                           n <span class="op">=</span> <span class="fl">200</span>, eps <span class="op">=</span> <span class="va">eps</span>, 
                                           value <span class="op">=</span> <span class="fl">0</span>, 
                                           multimodal <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fl">.95</span>, 
                                           summary_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">zero_p</span><span class="op">$</span><span class="va">param_posterior_sum</span>
<span class="co">#&gt;          begin       end</span>
<span class="co">#&gt; [1,] 0.1933673 0.2860167</span>
<span class="co">#&gt; [2,] 0.4127005 0.7284646</span>
<span class="co">#&gt; [3,] 0.8078783 0.9931770</span>
<span class="co">#&gt; attr(,"credMass")</span>
<span class="co">#&gt; [1] 0.95</span>
<span class="co">#&gt; attr(,"height")</span>
<span class="co">#&gt; [1] 0.3945052</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">zero_p</span>, mode <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>design <span class="op">=</span> <span class="st">"
A
B"</span>, guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="the-question-has-to-make-sense-" class="section level3">
<h3 class="hasAnchor">
<a href="#the-question-has-to-make-sense-" class="anchor"></a>The question has to make sense.</h3>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>
<span class="va">linear_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span>
<span class="va">linear_data</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">linear_data</span><span class="op">$</span><span class="va">x</span><span class="op">*</span><span class="fl">.5</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">linear_data</span><span class="op">$</span><span class="va">x</span>, <span class="va">linear_data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="va">fit_lin</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, 
                   data<span class="op">=</span><span class="va">linear_data</span>,
                   chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>,
                   iter <span class="op">=</span> <span class="fl">4500</span>, warmup <span class="op">=</span> <span class="fl">2000</span>,
                   control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.999</span>, max_treedepth <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                   file <span class="op">=</span> <span class="st">'fit_lin'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_lin</span><span class="op">)</span>
<span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. Increasing adapt_delta</span>
<span class="co">#&gt; above 0.999 may help. See http://mc-stan.org/misc/warnings.html#divergent-</span>
<span class="co">#&gt; transitions-after-warmup</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: y ~ s(x) </span>
<span class="co">#&gt;    Data: linear_data (Number of observations: 200) </span>
<span class="co">#&gt; Samples: 4 chains, each with iter = 4500; warmup = 2000; thin = 1;</span>
<span class="co">#&gt;          total post-warmup samples = 10000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Smooth Terms: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sds(sx_1)     0.70      0.71     0.02     2.69 1.00     2793     3867</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept     0.02      0.07    -0.11     0.15 1.00     9672     7314</span>
<span class="co">#&gt; sx_1          2.92      1.82    -1.44     6.17 1.00     3521     3281</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     0.99      0.05     0.90     1.09 1.00    10613     7756</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">fit_lin</span>, ask <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-1.png" width="700"><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/conditional_smooths.brmsfit.html">conditional_smooths</a></span><span class="op">(</span><span class="va">fit_lin</span>, smooths <span class="op">=</span> <span class="st">'s(x)'</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-3.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">deriv_lin</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit_lin</span>, term <span class="op">=</span> <span class="st">'s(x)'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_lin</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-4.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_lin</span>, robust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-5.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_lin</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-11-6.png" width="700"></p>
<p>What’s the maximum slope along a line?</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">max_lin</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_maxy</a></span><span class="op">(</span><span class="va">fit_lin</span>, term <span class="op">=</span> <span class="st">'x'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, adjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_lin</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">linear_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">linear_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="downlit">

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">linear_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin</span>, adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin</span>, adjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin</span>, adjust <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">'collect'</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Warning in plot.curvish.param(max_lin, adjust = 2): Adjusting density bandwidth</span>
<span class="co">#&gt; to be different from that used to compute the HPDI.</span>
<span class="co">#&gt; Warning in plot.curvish.param(max_lin, adjust = 0.5): Adjusting density</span>
<span class="co">#&gt; bandwidth to be different from that used to compute the HPDI.</span>
<span class="co">#&gt; Warning in plot.curvish.param(max_lin, adjust = 0.1): Adjusting density</span>
<span class="co">#&gt; bandwidth to be different from that used to compute the HPDI.</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-12-2.png" width="700"></p>
<p>Clearly the correct answer is that the entire curve is of maximum slope, but the posterior we derive incorrectly excludes a portion, by necessity. This can be understood, perhaps, as an instance of model misspecification. One should never expect to get the right answer from the wrong question.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">zero_lin</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_yequalto</a></span><span class="op">(</span><span class="va">fit_lin</span>, term <span class="op">=</span> <span class="st">'x'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; Warning in FUN(newX[, i], ...): More than one point matched. Sampling one at</span>
<span class="co">#&gt; random.</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_lin</span>, deriv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">fit_lin</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">zero_lin</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">fit_lin</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Interestingly we can see that it is most likely to be 0 where we have the least data, and least likely where we have the most data.</p>
<p>Finally, consider using the histogram overlay to check the density plots.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">max_lin_uni</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/posterior_x_at_fy.html">posterior_x_at_maxy</a></span><span class="op">(</span><span class="va">fit_lin</span>, term <span class="op">=</span> <span class="st">'x'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, multimodal <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin_uni</span>, histogram <span class="op">=</span> <span class="cn">TRUE</span>, adjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin_uni</span>, histogram <span class="op">=</span> <span class="cn">TRUE</span>, adjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">max_lin_uni</span>, histogram <span class="op">=</span> <span class="cn">TRUE</span>, adjust <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
</div>
</div>
<div id="regions-along-the-slope" class="section level1">
<h1 class="hasAnchor">
<a href="#regions-along-the-slope" class="anchor"></a>Regions along the slope</h1>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="va">deriv_b2</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">::</span><span class="fu"><a href="../reference/derivatives.html">derivatives</a></span><span class="op">(</span><span class="va">fit_b</span>, term <span class="op">=</span> <span class="st">'x2'</span>, n <span class="op">=</span> <span class="va">res</span>, eps <span class="op">=</span> <span class="va">eps</span>, deriv_posterior <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fl">.95</span>, prob_outer <span class="op">=</span> <span class="fl">.999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b2</span>, deriv <span class="op">=</span> <span class="cn">TRUE</span>, outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">ap</span> <span class="op">&lt;-</span> <span class="va">deriv_b2</span><span class="op">$</span><span class="va">deriv_posterior</span>

<span class="va">onoff_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">ap</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>pGT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>, pLT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">ps</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="co"># is it confidently above or below 0</span>
  <span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
  <span class="va">nS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ps</span>, C <span class="op">=</span> <span class="va">C</span>, S <span class="op">=</span> <span class="va">S</span>, nS <span class="op">=</span> <span class="va">nS</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">total_type_S_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">onoff_mat</span><span class="op">[</span><span class="st">'nS'</span>,<span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ap</span><span class="op">)</span>
<span class="va">confident_type_S_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">onoff_mat</span><span class="op">[</span><span class="st">'nS'</span>, <span class="va">onoff_mat</span><span class="op">[</span><span class="st">'S'</span>,<span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ap</span><span class="op">[</span>, <span class="va">onoff_mat</span><span class="op">[</span><span class="st">'S'</span>,<span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span><span class="op">]</span><span class="op">)</span>

<span class="va">confidence_regions</span> <span class="op">&lt;-</span> <span class="va">onoff_mat</span><span class="op">[</span><span class="st">'C'</span>,<span class="op">]</span>
<span class="va">confidence_regions</span><span class="op">[</span><span class="va">onoff_mat</span><span class="op">[</span><span class="st">'S'</span>, <span class="op">]</span> <span class="op">&gt;</span> <span class="fl">.05</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="va">region_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">deriv_b2</span><span class="op">$</span><span class="va">deriv_posterior_summary</span>, 
                     region <span class="op">=</span> <span class="va">confidence_regions</span>,
                     `Confidence Region` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">confidence_regions</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'GT'</span>, <span class="st">'-'</span>, <span class="st">'LT'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu">curvish</span><span class="fu">:::</span><span class="fu"><a href="../reference/contiguous_zeros.html">contiguous_zeros</a></span><span class="op">(</span><span class="va">region_data</span>, colname <span class="op">=</span> <span class="st">'region'</span>, indexcol <span class="op">=</span> <span class="st">'x2'</span><span class="op">)</span>
<span class="va">region_data</span><span class="op">$</span><span class="va">region_group</span> <span class="op">&lt;-</span> <span class="va">blocks</span><span class="op">$</span><span class="va">index</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">deriv_b2</span>, deriv <span class="op">=</span> <span class="cn">TRUE</span>, outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">region_data</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">`Confidence Region`</span>, group <span class="op">=</span> <span class="va">region_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'GT'</span>, <span class="st">'-'</span>, <span class="st">'LT'</span><span class="op">)</span>, values <span class="op">=</span> <span class="fu">curvish</span><span class="fu">:::</span><span class="fu"><a href="../reference/a_pal.html">a_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></pre></div>
<p><img src="finding-plateaus_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'P(Type-S) = %0.1f%% in confidence regions.'</span>, <span class="va">confident_type_S_prob</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; P(Type-S) = 0.8% in confidence regions.</span>
<span class="va">blocks</span><span class="op">$</span><span class="va">block_lengths</span>
<span class="co">#&gt;    n mean is_zero        start       end</span>
<span class="co">#&gt; 0 46    1   FALSE 0.0006632213 0.2262061</span>
<span class="co">#&gt; 1  5    0    TRUE 0.2312181928 0.2512665</span>
<span class="co">#&gt; 2 38   -1   FALSE 0.2562785158 0.4417249</span>
<span class="co">#&gt; 3 48    0    TRUE 0.4467369704 0.6823040</span>
<span class="co">#&gt; 4 30   -1   FALSE 0.6873160711 0.8326659</span>
<span class="co">#&gt; 5 33    0    TRUE 0.8376780090 0.9980641</span></pre></div>
</div>
<div id="differences-along-the-curve" class="section level1">
<h1 class="hasAnchor">
<a href="#differences-along-the-curve" class="anchor"></a>Differences along the curve</h1>
</div>
<div id="coming-up" class="section level1">
<h1 class="hasAnchor">
<a href="#coming-up" class="anchor"></a>Coming up</h1>
<p>Find the posterior of differences from various points in the curve, or credible intervals for differences along arbitrary values.</p>
<p>Also, combine objects like posteriors for max slopes and the slopes themselves to make plots of regions of the curve that have certain properties.</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="va">deriv1_age_at_max_post</span> <span class="op">&lt;-</span> <span class="va">c_smooths_1_sample_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'max_age'</span> <span class="op">=</span> <span class="va">Age</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">deriv1</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">deriv1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                                                  by <span class="op">=</span> <span class="st">'sample__'</span><span class="op">]</span>
<span class="va">age_at_max_med_deriv</span> <span class="op">&lt;-</span> <span class="va">deriv1_post_summary</span><span class="op">[</span><span class="va">deriv1</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">deriv1</span><span class="op">)</span>, <span class="va">Age</span><span class="op">]</span>
<span class="va">deriv1_diff_from_max_post</span> <span class="op">&lt;-</span> <span class="va">c_smooths_1_sample_data</span><span class="op">[</span>, <span class="va">diff_from_max</span> <span class="op">:=</span> <span class="va">deriv1</span> <span class="op">-</span> <span class="va">deriv1</span><span class="op">[</span><span class="va">Age</span> <span class="op">==</span> <span class="va">age_at_max_med_deriv</span><span class="op">]</span>,
                                                     by <span class="op">=</span> <span class="st">'sample__'</span><span class="op">]</span>
<span class="va">deriv1_diff_from_max_post_summary</span> <span class="op">&lt;-</span> <span class="va">deriv1_diff_from_max_post</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'diff_from_max'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">diff_from_max</span><span class="op">)</span>, 
                                                                      <span class="st">'lower'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">diff_from_max</span>, probs <span class="op">=</span> <span class="fl">.025</span><span class="op">)</span>, 
                                                                      <span class="st">'upper'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">diff_from_max</span>, probs <span class="op">=</span> <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>,
                                                               by <span class="op">=</span> <span class="st">'Age'</span><span class="op">]</span>
<span class="va">deriv1_diff_from_max_post_summary</span><span class="op">[</span>, <span class="va">compared_to_max</span> <span class="op">:=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">upper</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">'less_steep'</span>,
                                                                 <span class="va">lower</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">'steeper'</span>,
                                                                 <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">'as_steep'</span><span class="op">)</span><span class="op">]</span>

<span class="va">deriv1_post_summary</span> <span class="op">&lt;-</span> <span class="va">deriv1_post_summary</span><span class="op">[</span><span class="va">deriv1_diff_from_max_post_summary</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">Age</span>, <span class="va">compared_to_max</span><span class="op">)</span><span class="op">]</span>, on <span class="op">=</span> <span class="st">'Age'</span><span class="op">]</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Flournoy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
